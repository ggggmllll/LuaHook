[**ä¸­æ–‡**](README.md) | [**English**](README_en.md)

# LuaHook: åŠ¨æ€Cå‡½æ•°ç»‘å®šåº“

ä¸€ä¸ªåŸºäº libffi çš„ Lua æ‰©å±•åº“ï¼Œå®ç° Lua ä¸ C çš„åŒå‘é«˜æ•ˆè°ƒç”¨ã€‚æ”¯æŒç»“æ„ä½“ä¼ é€’ã€å¯å˜å‚æ•°å‡½æ•°ã€ABI é€‰æ‹©ç­‰ç‰¹æ€§ï¼Œæ— éœ€ç¼–å†™èƒ¶æ°´ä»£ç å³å¯ç›´æ¥è°ƒç”¨ä»»æ„ C å‡½æ•°æˆ–å°† Lua å‡½æ•°æš´éœ²ç»™ C ä½¿ç”¨ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- **åŒå‘è°ƒç”¨**ï¼š
  - å°†ä»»æ„ C å‡½æ•°æŒ‡é’ˆåŒ…è£…ä¸º Lua å¯è°ƒç”¨å¯¹è±¡ï¼ˆ`wrapNative`ï¼‰
  - å°† Lua å‡½æ•°åŒ…è£…ä¸º C å‡½æ•°æŒ‡é’ˆï¼ˆ`wrapLua`ï¼‰ï¼Œé€šè¿‡ libffi closure å®ç°
- **ç»“æ„ä½“æ”¯æŒ**ï¼š
  - æ³¨å†Œ C ç»“æ„ä½“å¸ƒå±€ï¼ŒLua ä¸­ç”¨æ•°ç»„è¡¨ç¤ºç»“æ„ä½“ï¼ˆæŒ‰å­—æ®µé¡ºåºï¼‰
  - è‡ªåŠ¨è®¡ç®—å­—æ®µåç§»é‡ï¼Œæ­£ç¡®å¤„ç†å¯¹é½
- **å¯å˜å‚æ•°å‡½æ•°**ï¼š
  - C å‡½æ•°ç­¾åæ”¯æŒ `...` æ ‡è®°ï¼Œå¯å˜å‚æ•°ç±»å‹ç”±æœ€åä¸€ä¸ªå›ºå®šå‚æ•°å†³å®šå¹¶è‡ªåŠ¨æå‡ï¼ˆ`float`â†’`double`ï¼Œå°äº `int` çš„æ•´æ•°â†’`int`/`unsigned int`ï¼‰
  - Lua é—­åŒ…åŒ…è£…æ—¶ä¸æ”¯æŒå¯å˜å‚æ•°
- **ABI é€‰æ‹©**ï¼šå¯åŠ¨æ€è®¾ç½®è°ƒç”¨çº¦å®šï¼ˆé€šè¿‡ `setAbi`ï¼‰
- **ç±»å‹å®‰å…¨**ï¼šç­¾åè§£æ + è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼Œé”™è¯¯ä¿¡æ¯æ¸…æ™°
- **å†…å­˜ç®¡ç†**ï¼š
  - C å‡½æ•°åŒ…è£…è¿”å› full userdataï¼ŒLua GC è‡ªåŠ¨å›æ”¶
  - Lua å‡½æ•°åŒ…è£…è¿”å› lightuserdataï¼Œéœ€æ‰‹åŠ¨é‡Šæ”¾ï¼ˆ`unwrapLua`ï¼‰
- **çº¿ç¨‹å®‰å…¨**ï¼šå…¨å±€æ˜ å°„è¡¨ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤

## ğŸ“¦ API å‚è€ƒ

æ‰€æœ‰å‡½æ•°é€šè¿‡æ¨¡å—è¡¨å¯¼å‡ºã€‚

### `LuaHook.setAbi(abi)`
è®¾ç½®å…¨å±€ FFI ABI ç¼–å·ã€‚å‚æ•°ä¸ºæ•´æ•°ï¼Œå–å€¼èŒƒå›´ä¸º `[FFI_FIRST_ABI, FFI_DEFAULT_ABI]`ï¼ˆç”± libffi å®šä¹‰ï¼‰ã€‚é»˜è®¤ä½¿ç”¨FFI_DEFAULT_ABIï¼Œé€šå¸¸æ— éœ€é¢å¤–è®¾ç½®ã€‚

### `LuaHook.registerStruct(name, signature)`
æ³¨å†Œä¸€ä¸ª C ç»“æ„ä½“ç±»å‹ã€‚
- `name`ï¼šå­—ç¬¦ä¸²ï¼Œç»“æ„ä½“åç§°ï¼ˆåç»­ç­¾åä¸­å¯ç”¨ï¼‰
- `signature`ï¼šå­—ç¬¦ä¸²ï¼Œå­—æ®µç±»å‹åˆ—è¡¨ï¼Œä¾‹å¦‚ `"ii"` è¡¨ç¤ºä¸¤ä¸ª `int` å­—æ®µã€‚
  ç­¾åæ ¼å¼ï¼šè‡ªå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ç”¨ `|` åŒ…å›´ã€‚

### `LuaHook.unregisterStruct(name)`
æ³¨é”€å·²æ³¨å†Œçš„ç»“æ„ä½“ã€‚

### `LuaHook.wrapNative(ptr, signature) -> userdata`
å°† C å‡½æ•°æŒ‡é’ˆåŒ…è£…ä¸º Lua å¯è°ƒç”¨çš„å¯¹è±¡ã€‚
- `ptr`ï¼šlightuserdataï¼ŒC å‡½æ•°åœ°å€
- `signature`ï¼šå­—ç¬¦ä¸²ï¼Œå‡½æ•°ç­¾åï¼Œæ ¼å¼ `"<è¿”å›ç±»å‹><å‚æ•°1>[å‚æ•°2][...]"`ã€‚è‹¥ä¸ºå¯å˜å‚æ•°ï¼Œåœ¨æœ€ååŠ  `...` æ ‡è®°ï¼ˆä¾‹å¦‚ `"ip..."`ï¼‰ã€‚ç­¾åæ ¼å¼ï¼šè‡ªå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ç”¨ `|` åŒ…å›´ã€‚
- è¿”å›å€¼ï¼šfull userdataï¼Œå¸¦æœ‰ `__call` å…ƒæ–¹æ³•ï¼Œå¯ç›´æ¥åœ¨ Lua ä¸­è°ƒç”¨ã€‚

### `LuaHook.wrapLua(func_name, signature) -> lightuserdata`
å°† Lua å‡½æ•°åŒ…è£…ä¸º C å‡½æ•°æŒ‡é’ˆï¼ˆé€šè¿‡ libffi closureï¼‰ã€‚
- `func_name`ï¼šå­—ç¬¦ä¸²ï¼Œå…¨å±€ Lua å‡½æ•°å
- `signature`ï¼šå­—ç¬¦ä¸²ï¼Œç­¾åæ ¼å¼åŒ `wrapNative`ï¼Œä½†**ä¸æ”¯æŒå¯å˜å‚æ•°**ï¼ˆå³ä¸èƒ½åŒ…å« `...`ï¼‰
- è¿”å›å€¼ï¼šlightuserdataï¼Œå³ç”Ÿæˆçš„ C å‡½æ•°å¯æ‰§è¡Œåœ°å€ï¼Œå¯ä¼ é€’ç»™éœ€è¦ C å›è°ƒçš„ APIã€‚

### `LuaHook.unwrapLua(code)`
é‡Šæ”¾ç”± `wrapLua` åˆ›å»ºçš„é—­åŒ…èµ„æºã€‚
- `code`ï¼šlightuserdataï¼Œä¹‹å‰è¿”å›çš„å¯æ‰§è¡Œåœ°å€ã€‚

### `LuaHook.getString(ptr)`
ä» `char*` æŒ‡é’ˆè·å–å­—ç¬¦ä¸²
- `ptr`ï¼šlightuserdataï¼Œå­—ç¬¦ä¸²åœ°å€ã€‚
- è¿”å›å€¼ï¼šå¯¹åº”åœ°å€å¤„å­—ç¬¦ä¸²ã€‚

### `LuaHook.registerArray(name, element_type, size)`
æ³¨å†Œä¸€ä¸ª C æ•°ç»„ç±»å‹ã€‚
- `name`ï¼šå­—ç¬¦ä¸²ï¼Œæ•°ç»„åç§°ï¼ˆåç»­ç­¾åä¸­å¯ç”¨ï¼‰
- `element_type`ï¼šå­—ç¬¦ä¸²ï¼Œæ•°ç»„å…ƒç´ ç±»å‹ã€‚
  ç­¾åæ ¼å¼ï¼šè‡ªå®šä¹‰çš„ç»“æ„ä½“ç±»å‹ç”¨ `|` åŒ…å›´ã€‚
- `size`ï¼šæ•´æ•°ï¼Œæ•°ç»„å¤§å°

## ğŸ”¢ ç±»å‹ç­¾åæ˜ å°„

### åŸºæœ¬ç±»å‹å•å­—ç¬¦

| å­—ç¬¦ | C ç±»å‹              | Lua ç±»å‹   | è¯´æ˜                     |
|------|---------------------|------------|--------------------------|
| `v`  | `void`              | `none`     | ä»…ç”¨äºè¿”å›å€¼             |
| `c`  | `signed char`       | `integer`  |                          |
| `C`  | `unsigned char`     | `integer`  |                          |
| `s`  | `signed short`      | `integer`  |                          |
| `S`  | `unsigned short`    | `integer`  |                          |
| `i`  | `signed int`        | `integer`  |                          |
| `I`  | `unsigned int`      | `integer`  |                          |
| `l`  | `signed long`       | `integer`  |                          |
| `L`  | `unsigned long`     | `integer`  |                          |
| `f`  | `float`             | `number`   |                          |
| `d`  | `double`            | `number`   |                          |
| `p`  | `void*` / æŒ‡é’ˆ      | `userdata` | lightuserdata æˆ– full userdata |
| `o`  | `long double`       | `number`   |                          |
| `...`| å¯å˜å‚æ•°æ ‡è®°        | -          | ä»…ç”¨äº C å‡½æ•°ç­¾å        |

### ç»“æ„ä½“ç±»å‹
ç­¾åä¸­ç”¨æ³¨å†Œæ—¶çš„åç§°ä»£æ›¿å­—ç¬¦ï¼Œä¾‹å¦‚å·²æ³¨å†Œç»“æ„ä½“ `"Point"`ï¼Œåˆ™ç­¾åä¸­å¯ç”¨ `|Point|` ä½œä¸ºä¸€ä¸ªå‚æ•°ç±»å‹ï¼Œç”¨ `|` åŒ…å›´ã€‚

ç»“æ„ä½“åœ¨ Lua ä¸­è¡¨ç¤ºä¸º**æ•°ç»„**ï¼Œå…ƒç´ é¡ºåºä¸ç»“æ„ä½“å­—æ®µå£°æ˜é¡ºåºä¸€è‡´ã€‚åµŒå¥—ç»“æ„ä½“é€’å½’å±•å¼€ã€‚

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```lua
local luahook = require("LuaHook")

-- è®¾ç½® ABIï¼ˆé€šå¸¸é»˜è®¤ 0ï¼‰
luahook.setAbi(0)

-- æ³¨å†Œç»“æ„ä½“ Point { int x, int y }
luahook.registerStruct("Point", "ii")
luahook.registerArray()

-- å‡è®¾æœ‰ä¸€ä¸ª C å‡½æ•°ï¼šint add(int a, int b);
-- ptr_add æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼è·å¾—çš„ lightuserdata
local add = luahook.wrapNative(ptr_add, "ii")
local result = add(3, 5)   -- è¿”å› 8

-- å‡è®¾ C å‡½æ•°ï¼švoid print_point(Point* p);
-- ptr_print_point æ˜¯å‡½æ•°æŒ‡é’ˆ
local print_point = luahook.wrapNative(ptr_print_point, "vp")
local point = {10, 20}     -- Lua æ•°ç»„è¡¨ç¤º Point
print_point(point)          -- C å‡½æ•°æ¥æ”¶æŒ‡é’ˆï¼Œè‡ªåŠ¨è½¬æ¢

-- å¯å˜å‚æ•° C å‡½æ•°ï¼šint sum(int count, ...);
local sum = luahook.wrapNative(ptr_sum, "ii...")
-- å¯å˜å‚æ•°éƒ¨åˆ†é‡å¤æœ€åä¸€ä¸ªå›ºå®šå‚æ•°ç±»å‹ï¼ˆintï¼‰ï¼Œå¹¶æå‡
print(sum(3, 1, 2, 3))      -- è¾“å‡º 6

-- å°† Lua å‡½æ•°åŒ…è£…ä¸º C å›è°ƒ
function lua_add(a, b)
    return a + b
end
local c_callback = luahook.wrapLua("lua_add", "iii")
-- å¯å°† c_callback ä¼ é€’ç»™éœ€è¦ C å›è°ƒçš„ API
-- ä¸å†ä½¿ç”¨æ—¶é‡Šæ”¾
luahook.unwrapLua(c_callback)
```

## ğŸ”§ ç¼–è¯‘ä¸ä¾èµ–

### ä¾èµ–
- Lua 5.1 / 5.2 / 5.3 / 5.4
- libffi
- pthreadï¼ˆç”¨äºçº¿ç¨‹å®‰å…¨ï¼‰

### ç¼–è¯‘ç¤ºä¾‹
æ‰‹åŠ¨ç¼–è¯‘ï¼š
```bash
cmake -B build && cd build && make
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¯å˜å‚æ•°é™åˆ¶**ï¼š`wrapLua` ä¸æ”¯æŒå¯å˜å‚æ•°ç­¾åï¼Œå› ä¸º libffi closure æ— æ³•å¤„ç†ã€‚å¦‚éœ€å°† Lua å‡½æ•°ç”¨ä½œå¯å˜å‚æ•°å›è°ƒï¼Œéœ€æ‰‹åŠ¨åŒ…è£…ã€‚
2. **ç»“æ„ä½“æ³¨å†Œé¡ºåº**ï¼šä½¿ç”¨ç»“æ„ä½“ä½œä¸ºå‚æ•°å‰å¿…é¡»å…ˆæ³¨å†Œã€‚
3. **æŒ‡é’ˆç”Ÿå‘½å‘¨æœŸ**ï¼š`wrapNative` ä¼ å…¥çš„ C å‡½æ•°æŒ‡é’ˆå¿…é¡»åœ¨æ•´ä¸ªä½¿ç”¨æœŸé—´æœ‰æ•ˆï¼›Lua ç«¯ä¸è´Ÿè´£ç®¡ç† C å‡½æ•°å†…å­˜ã€‚
4. **çº¿ç¨‹å®‰å…¨**ï¼šå…¨å±€æ˜ å°„è¡¨ä½¿ç”¨äº’æ–¥é”ï¼Œä½† Lua çŠ¶æ€æœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¯·å‹¿åœ¨å¤šçº¿ç¨‹ä¸­å…±äº«åŒä¸€ Lua çŠ¶æ€è°ƒç”¨æœ¬åº“ã€‚
5. **é”™è¯¯å¤„ç†**ï¼šç­¾åè§£æå¤±è´¥æˆ–ç±»å‹ä¸åŒ¹é…ä¼šæŠ›å‡º Lua é”™è¯¯ï¼ˆ`lua_error`ï¼‰ã€‚

---

æ¬¢è¿è´¡çŒ® Issue å’Œ PRï¼
